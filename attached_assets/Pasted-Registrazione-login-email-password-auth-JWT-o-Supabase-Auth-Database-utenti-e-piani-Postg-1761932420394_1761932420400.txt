Registrazione / login (email + password) — auth JWT o Supabase Auth.

Database utenti e piani (Postgres via Supabase o PostgreSQL manutenuto).

Integrazione Stripe Billing per piani (Free / Pro / Business) e webhooks per sincronizzare abbonamenti.

Pagina dashboard minima dove l’utente vede stato abbonamento e può avviare checkout.

Script + checklist per deploy su Vercel/Render in produzione.

Tech stack consigliato (per questa settimana)

Frontend: Next.js (13+) + TypeScript + Tailwind CSS

Backend (API): API Routes Next.js (serverless) o Node/Express se preferisci separare

DB & Auth: Supabase (Postgres + Auth) — semplifica molto integrazione (oppure PostgreSQL + Auth custom)

Pagamenti: Stripe Billing (Checkout + Customer Portal + Webhooks)

Storage immagini future: Supabase Storage o S3 (non necessario settimana 1)

Hosting dev: Replit (per sviluppo rapido). Produzione: Vercel o Render

0 — Prerequisiti (account)

Account Stripe (dashboard.stripe.com) — chiave API test e live.

Account Supabase (supabase.com) o accesso a un PostgreSQL.

Account Replit (o accesso al repo su GitHub).

Node.js (se lavori localmente) — ma su Replit non serve installare.

1 — Struttura cartelle (Next.js app)
propertycopypro/
├─ app/ or pages/            # Next.js pages (usa app/ se Next13+)
├─ components/
│  ├─ AuthForm.tsx
│  ├─ Navbar.tsx
│  └─ Dashboard.tsx
├─ lib/
│  ├─ supabaseClient.ts
│  ├─ stripe.ts
│  └─ auth.ts
├─ pages/api/
│  ├─ auth/ (se fai auth custom)
│  ├─ stripe/create-checkout-session.ts
│  ├─ stripe/webhook.ts
│  └─ user/subscription.ts
├─ prisma/ (se usi Prisma)
├─ public/
├─ styles/
├─ .env.local
├─ package.json
└─ README.md

2 — Database: schema minimo (Postgres)

Se usi Supabase puoi creare queste tabelle via SQL editor. Ecco uno schema base:

-- users: se usi Supabase Auth, user info è già in auth.users, ma aggiungi profilo
create table profiles (
  id uuid primary key references auth.users(id),
  full_name text,
  company text,
  role text,
  created_at timestamptz default now()
);

-- subscriptions: traccia abbonamenti lato app (sincronizza con Stripe)
create table subscriptions (
  id text primary key, -- stripe subscription id
  user_id uuid references profiles(id),
  price_id text,
  status text,
  current_period_start timestamptz,
  current_period_end timestamptz,
  cancel_at_period_end boolean default false,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- credits (per pagamenti credit pack)
create table credits (
  id serial primary key,
  user_id uuid references profiles(id),
  amount int,
  created_at timestamptz default now()
);


Se usi Prisma, mappa questi nello schema schema.prisma.

3 — Autenticazione (raccomandazione)

Due strade:

A) Supabase Auth (consigliato) — molto veloce: signup/login email link o password; SDK client per Next.js.
B) Auth custom JWT — devi gestire hashing password, refresh token, email verification.

Per MVP usa Supabase Auth. Esempio lib/supabaseClient.ts:

import { createClient } from '@supabase/supabase-js';

export const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);


Frontend: usa supabase.auth.signUp() e supabase.auth.signInWithPassword().

4 — Stripe Billing: account + prodotti/piani

In Stripe Dashboard → Products crea:

Product: PropertyCopy Pro - Pro → Price: 29 EUR monthly (price_id: ex. price_1...)

Product: PropertyCopy Pro - Business → Price: 79 EUR monthly

Product Free: you can create a free SKU tracked only in DB (or handle in app).

Credit Pack: Credit Pack 100 → one-time price 9 EUR

Attiva Stripe Billing e Customer Portal (facoltativo ma utile).

Prendi le chiavi:

STRIPE_SECRET_KEY (sk_test_...)

STRIPE_WEBHOOK_SECRET (lo generi quando crei webhook)

NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY (pk_test_...)

Crea un endpoint per create-checkout-session che crea un oggetto session o subscription.

Esempio pages/api/stripe/create-checkout-session.ts (Next API route — semplificato):

import { NextApiRequest, NextApiResponse } from 'next';
import Stripe from 'stripe';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, { apiVersion: '2022-11-15' });

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  const { priceId, successUrl, cancelUrl, customerEmail } = req.body;

  try {
    // crea checkout session
    const session = await stripe.checkout.sessions.create({
      mode: 'subscription',
      payment_method_types: ['card'],
      line_items: [{ price: priceId, quantity: 1 }],
      customer_email: customerEmail, // optional
      success_url: successUrl,
      cancel_url: cancelUrl,
    });

    res.status(200).json({ url: session.url });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: 'stripe error' });
  }
}


Nota: per abbonamenti ricorrenti preferibile impostare mode: 'subscription' e price di tipo recurring.

5 — Webhook Stripe: sincronizzare abbonamenti sul DB

Crea pages/api/stripe/webhook.ts. Stripe invierà eventi come checkout.session.completed, invoice.paid, customer.subscription.updated, customer.subscription.deleted. Aggiorna la tabella subscriptions di conseguenza.

Snippet (semplificato):

import { buffer } from 'micro';
import Stripe from 'stripe';
import { supabase } from '../../lib/supabaseClient';

export const config = { api: { bodyParser: false } }

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, { apiVersion: '2022-11-15' });

export default async function handler(req, res) {
  const buf = await buffer(req);
  const sig = req.headers['stripe-signature']!;
  let event;

  try {
    event = stripe.webhooks.constructEvent(buf.toString(), sig, process.env.STRIPE_WEBHOOK_SECRET!);
  } catch (err) {
    console.error('Webhook signature verification failed.', err);
    return res.status(400).send(`Webhook Error: ${err.message}`);
  }

  // handle events
  if (event.type === 'checkout.session.completed') {
    const session = event.data.object;
    // find user by email and create subscription record or create customer mapping
    // ...
  } else if (event.type === 'customer.subscription.updated' || event.type === 'customer.subscription.created') {
    const subscription = event.data.object;
    // upsert into subscriptions table
  } else if (event.type === 'customer.subscription.deleted') {
    // mark cancelled in DB
  }

  res.json({ received: true });
}


Importante: su Replit / Vercel esponi l'endpoint con https e configura Stripe webhook con URL pubblico.

6 — Frontend: pagine essenziali

/ — landing page con CTA: crea account, prova gratis

/auth/signup — form sign up (email, password, nome)

/auth/login

/dashboard — mostra stato abbonamento (Free / Pro / Business), pulsante “Abbonati” che richiama endpoint create-checkout-session

/account — gestione profilo + pulsante per accedere al Customer Portal Stripe (facoltativo)

Esempio minimal dashboard che mostra piano (fetch subscription via API /api/user/subscription).

7 — Ambiente (.env.local)

Esempio .env.local (NON metterle in repo pubblico):

NEXT_PUBLIC_SUPABASE_URL=https://your-supabase-url.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

STRIPE_SECRET_KEY=sk_test_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

NEXTAUTH_SECRET=some-random-secret-if-using-nextauth
DATABASE_URL=postgresql://user:pass@host:5432/dbname   # se non supabase

8 — Replit: configurazione progetto

Crea nuovo Replit → Importa repo Git (o crea progetto Node/Next).

Aggiungi file .replit e replit.nix (se necessario) — ma Replit supporta Next.js out-of-the-box in molti casi.

Nella tab Environment variables di Replit, aggiungi le chiavi sopra (STRIPE_*, SUPABASE_*, ecc.).

Avvia Replit — verifica /api/health che ritorni 200.

Consiglio: tieni Replit per sviluppo. Per produzione deploy su Vercel (deploy automatico da GitHub) o Render per maggiore controllo.

9 — Test end-to-end (checklist)

Signup con email — l’utente viene creato in Supabase e profilo inserito.

Login → token/session attivo.

Dashboard mostra stato Free.

Clic su “Abbonati” → chiama POST /api/stripe/create-checkout-session → ricevi session.url → reindirizza al checkout Stripe (test mode).

Completa checkout con carta test (visa: 4242 4242 4242 4242) → Stripe invia checkout.session.completed.

Webhook riceve evento → crea/aggiorna record subscriptions per l’utente.

Ritorna a success_url → dashboard ora mostra piano Pro attivo con data scadenza.

Simula cancellazione in Stripe → webhook customer.subscription.deleted → DB aggiornato.

10 — Codice: endpoint essenziali (bozza rapida)

POST /api/stripe/create-checkout-session — crea session.

POST /api/stripe/webhook — riceve eventi.

GET /api/user/subscription — restituisce stato abbonamento per utente.

POST /api/user/create-profile — crea profilo in DB dopo signup.

11 — Sicurezza e best practice

MAI commitare le chiavi .env.

Verifica signature del webhook con STRIPE_WEBHOOK_SECRET.

Usa HTTPS sempre (Replit/ Vercel lo forniscono).

Per chiamate server->Stripe usa solo STRIPE_SECRET_KEY lato server.

Limita rate per endpoint pubblici.

Proteggi le rotte API con sessione valida (Supabase session o JWT).

12 — Timeline dettagliata per la Settimana 1 (giorno per giorno)

Giorno 1 (oggi):

Setup repo su Replit / GitHub.

Configurare Supabase (progetto + DB) e creare tabelle.

Creare account Stripe e creare products/prices.

Giorno 2:

Implementare Supabase client + pagine signup/login.

Testare registrazione e profili (DB).

Giorno 3:

Implementare create-checkout-session e pagina checkout flow.

Test Stripe checkout in modalità test.

Giorno 4:

Implementare webhook endpoint e logica di upsert su subscriptions.

Test webhook con stripe-cli o dal dashboard.

Giorno 5:

Dashboard utente che mostra stato abbonamento.

Aggiungere Customer Portal (opzionale).

Giorno 6:

Test end-to-end, fixing bug, scrivere README per deploy.
Giorno 7:

Preparazione deploy su Vercel & checklist sicurezza.

13 — Esempi utili / snippet copy-paste

Ti ho dato sopra i pezzi più critici (create-checkout-session e webhook). Se vuoi, nello step successivo ti preparo il repo starter completo con:

Next.js basic app

Auth Supabase

API stripe endpoints

Esempio Dashboard + UI minimale Tailwind

Dimmi solo: preferisci che lo generi come repo GitHub pronto da importare su Replit?
(Se sì, io fornisco il codice qui e tu lo copi su repo; non posso creare il repo direttamente da qui.)

14 — Cose che farò subito per te (in questa risposta)

Ti ho dato struttura, codice base, schema DB, env vars e checklist di test.

Se vuoi adesso, posso generare il codice completo per il repo starter (file principali: package.json, next.config.js, lib/supabaseClient.ts, pages/api/stripe/*, pages/index.tsx, pages/dashboard.tsx, ecc.) da incollare nel progetto Replit.

Oppure vogliamo procedere iterativamente: prima installi Supabase e Stripe e mi dici quando sei pronto per che io generi il repo starter.